# v1.1.2 多链接重试 & 收起/展开功能说明

## 🎯 新增功能

### 1️⃣ 多链接智能重试

#### 原理
每个视频在 API 响应中包含 3 个下载链接：
```javascript
{
  download_urls: [
    "https://v3-cold3.douyinvod.com/...",     // CDN 1
    "https://v81-cold.douyinvod.com/...",     // CDN 2
    "https://creator.douyin.com/aweme/..."    // 创作者端点
  ]
}
```

#### 重试策略
```
尝试顺序：
1. 链接 1 - 尝试 1 (失败) → 等待 2-4 秒
2. 链接 1 - 尝试 2 (失败) → 等待 1-2 秒 → 切换
3. 链接 2 - 尝试 1 (失败) → 等待 2-4 秒
4. 链接 2 - 尝试 2 (失败) → 等待 1-2 秒 → 切换
5. 链接 3 - 尝试 1 (失败) → 等待 2-4 秒
6. 链接 3 - 尝试 2 (成功) ✅ → 下载完成
```

**关键特点**：
- ✅ **3 个链接**: 最多可尝试 3 个不同的 CDN/源
- ✅ **2 次重试/链接**: 每个链接最多尝试 2 次
- ✅ **共 6 次尝试**: 3 × 2 = 最多 6 次机会
- ✅ **智能延迟**: 链接内重试用 2-4 秒，链接间切换用 1-2 秒

#### 控制台日志示例
```
📥 开始下载: 视频标题.mp4 (3 个链接)
📥 开始下载: 视频标题.mp4 URL: https://v3-cold3...
📊 响应状态: 403 Forbidden
❌ 下载失败: 视频标题.mp4 Error: HTTP 403
⚠️ 链接 1 下载失败，2.3秒后重试...
📥 开始下载: 视频标题.mp4 URL: https://v3-cold3...
📊 响应状态: 403 Forbidden
❌ 下载失败: 视频标题.mp4 Error: HTTP 403
🔄 切换到链接 2/3...
📥 开始下载: 视频标题.mp4 URL: https://v81-cold...
📊 响应状态: 403 Forbidden
❌ 下载失败: 视频标题.mp4 Error: HTTP 403
⚠️ 链接 2 下载失败，3.8秒后重试...
📥 开始下载: 视频标题.mp4 URL: https://v81-cold...
📊 响应状态: 403 Forbidden
❌ 下载失败: 视频标题.mp4 Error: HTTP 403
🔄 切换到链接 3/3...
📥 开始下载: 视频标题.mp4 URL: https://creator.douyin.com...
📊 响应状态: 200 OK
📦 Blob 大小: 15.6 MB
✅ 触发下载: 视频标题.mp4
✅ 下载成功: 视频标题.mp4
```

#### 为什么有效？

| 链接类型 | 特点 | 失败原因 |
|---------|------|---------|
| **CDN 1** | 高速，地理位置优化 | 可能限流、地区限制 |
| **CDN 2** | 备用 CDN，不同源 | 可能被不同策略限制 |
| **Creator** | 官方创作者端点 | 权限最高但可能负载高 |

多链接策略利用了：
- ✅ **冗余**: 一个链接失败，还有 2 个备选
- ✅ **分散负载**: 不同的 CDN 节点，绕过单点限制
- ✅ **防备**: 一个源被限流，其他源可能还能访问

---

### 2️⃣ 进度窗口收起/展开

#### 使用方法
1. **点击标题栏** (`📥 批量下载进度` 区域)
2. **自动切换状态**：
   - 展开时：显示完整列表，标题栏末尾为 `−`
   - 收起时：隐藏列表，标题栏末尾为 `+`

#### 界面示例

**展开状态** (默认):
```
┌──────────────────────────────┐
│ 📥 批量下载进度    5/10    − │
├──────────────────────────────┤
│ ✅ 视频1.mp4              │
│ ✅ 视频2.mp4              │
│ ✅ 视频3.mp4              │
│ ⬇️ 视频4.mp4              │
│ ⏳ 视频5.mp4              │
└──────────────────────────────┘
```

**收起状态** (点击后):
```
┌──────────────────────────────┐
│ 📥 批量下载进度    5/10    + │
└──────────────────────────────┘
```

#### 优势
- ✅ **节省空间**: 屏幕不被占满
- ✅ **实时计数**: 进度数字始终可见
- ✅ **灵活切换**: 随时展开查看详情
- ✅ **顺滑动画**: CSS 过渡效果平滑

---

## 📊 预期效果对比

### 成功率预测

**场景**: 12 个视频下载

| 版本 | 单链接 | 单链接 + 重试 | 多链接 + 重试 |
|------|--------|-------------|-------------|
| **v1.1.0** | 67% (8/12) | N/A | N/A |
| **v1.1.1** | N/A | ~75% (9/12) | N/A |
| **v1.1.2** | N/A | N/A | **预计 90%+ (11/12)** |

**原理**:
- v1.1.0: 单链接，无重试 → 失败率高
- v1.1.1: 单链接，2 次重试 → 成功率有所提升
- v1.1.2: 3 个链接，每个重试 2 次 → 大幅提升，接近满分

### 时间成本

每个视频下载耗时（失败场景）：

```
成功：~2-4 秒 (单次 fetch)
失败 1 次重试：~2-4 + 2-4 = 4-8 秒
失败 3 个链接各 1 次：~3 × (2-4) = 6-12 秒
失败完全重试：~3 × 2 × (2-4) = 12-24 秒（极端情况）
```

**12 个视频总耗时**:
- 全部成功：~12 × 3 + 11 × 3 (间隔) = ~66 秒
- 部分失败（3-4 个重试）：~80-100 秒

---

## 🧪 测试步骤

### 测试 1: 多链接重试

**准备**:
1. 重新加载扩展
2. 打开开发者工具 (F12)
3. 选择 5 个视频
4. 点击下载

**观察**:
- ✅ 控制台显示 "3 个链接"
- ✅ 失败时显示 "链接 1 下载失败"
- ✅ 自动切换 "切换到链接 2/3"
- ✅ 使用了多个不同的 URL

**预期结果**:
- 成功率 > 90%
- 部分失败的视频经过多链接重试后成功

---

### 测试 2: 收起/展开

**步骤**:
1. 开始下载
2. 右上角出现进度窗口
3. 点击 "📥 批量下载进度" 标题栏

**观察**:
- ✅ 列表消失，仅显示标题栏
- ✅ 右端图标从 `−` 变为 `+`
- ✅ 进度数字仍然可见（如 "5/10"）
- ✅ 再次点击展开

**验证点**:
- ✅ 动画平滑（CSS 过渡）
- ✅ 收起时节省了空间
- ✅ 计数准确更新

---

## 🔧 技术细节

### 缓存结构变化

**v1.1.1**:
```javascript
{
  aweme_id: "xxx",
  download_url: "https://...",  // 单个链接
  title: "视频"
}
```

**v1.1.2**:
```javascript
{
  aweme_id: "xxx",
  download_urls: ["https://...", "https://...", "https://..."],  // 数组
  title: "视频"
}
```

**内存影响**: 增加 ~50 字节/视频（仍然很轻量）

### 重试函数伪代码

```javascript
async function downloadVideoWithRetry(downloadUrls, filename) {
  // 3 个链接
  for (let urlIndex = 0; urlIndex < downloadUrls.length; urlIndex++) {
    const url = downloadUrls[urlIndex];
    
    // 每个链接最多重试 2 次
    for (let attempt = 1; attempt <= 2; attempt++) {
      const success = await downloadVideo(url, filename);
      if (success) return true;
      
      // 链接内重试延迟
      if (attempt < 2) {
        await sleep(2000 + Math.random() * 2000);
      }
    }
    
    // 链接间切换延迟
    if (urlIndex < downloadUrls.length - 1) {
      await sleep(1000 + Math.random() * 1000);
    }
  }
  
  return false; // 全部失败
}
```

### UI 收起/展开实现

```javascript
// 监听点击
header.addEventListener('click', () => {
  isExpanded = !isExpanded;
  if (isExpanded) {
    list.style.maxHeight = '400px';
    list.style.padding = '8px';
    toggleBtn.textContent = '−';
  } else {
    list.style.maxHeight = '0px';
    list.style.padding = '0px';
    toggleBtn.textContent = '+';
  }
});
```

**关键**: 使用 `max-height` 和 `padding` 实现平滑收起/展开

---

## 📈 改进总结

| 功能 | v1.1.1 | v1.1.2 | 改进 |
|------|--------|--------|------|
| **链接数** | 1 | 3 | ✅ 3 倍 |
| **重试机制** | 2 次/链接 | 2 次/链接 × 3 | ✅ 共 6 次 |
| **预期成功率** | ~75% | ~90%+ | ✅ +15% |
| **UI 收起** | ❌ | ✅ | ✅ 新增 |
| **内存占用** | 100 字节/个 | 150 字节/个 | ⚠️ +50% (仍轻) |

---

## 🚀 使用建议

### 最佳实践
1. **每次 5-15 个视频** → 成功率最高（> 90%）
2. **监控进度** → 可收起窗口节省空间
3. **遇到全失败** → 等 10 分钟，刷新页面后重试

### 故障排除

| 现象 | 可能原因 | 解决方案 |
|------|---------|---------|
| **全部 403** | 账号限流 | 等 20 分钟，切换时间段 |
| **部分 403** | 链接失效 | 刷新页面重新加载 |
| **链接都失败** | API 问题 | 检查网络，稍后重试 |

---

## ✅ 验收清单

- [ ] 多链接重试正常工作
- [ ] 控制台显示链接切换日志
- [ ] 成功率提升到 90%+
- [ ] 收起/展开功能顺利
- [ ] UI 动画平滑
- [ ] 进度数字始终可见
